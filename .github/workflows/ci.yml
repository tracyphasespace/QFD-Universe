name: QFD-Universe CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Weekly Lean build check (Sundays 3am UTC)
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  python-validations:
    name: Python Validations
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run simulation validations
      run: |
        cd analysis/scripts
        python run_all_validations.py --quick
      continue-on-error: true  # Some tests need NuBase data

    - name: Check Golden Loop equation
      run: |
        python -c "
        import numpy as np
        beta = 3.043233053
        alpha_inv = 137.035999084
        lhs = 2 * np.pi**2 * (np.exp(beta) / beta) + 1
        error = abs(lhs - alpha_inv) / alpha_inv
        print(f'Golden Loop: 2π²(e^β/β) + 1 = {lhs:.9f}')
        print(f'Target: 1/α = {alpha_inv}')
        print(f'Error: {error:.2e}')
        assert error < 1e-9, f'Golden Loop equation error too large: {error}'
        print('✓ Golden Loop equation verified')
        "

  lean-build:
    name: Lean Build
    runs-on: ubuntu-latest
    # Only run on schedule or manual trigger (expensive)
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
    - uses: actions/checkout@v4

    - name: Install elan
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH

    - name: Cache Lean build
      uses: actions/cache@v4
      with:
        path: |
          formalization/.lake
          ~/.elan
        key: lean-${{ hashFiles('formalization/lean-toolchain', 'formalization/lakefile.toml') }}
        restore-keys: |
          lean-

    - name: Build Lean proofs
      run: |
        cd formalization
        lake update
        lake build QFD
      timeout-minutes: 60

  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Verify machine-readable indexes exist
      run: |
        test -f docs/llms.txt || exit 1
        test -f docs/urls.txt || exit 1
        test -f docs/files.json || exit 1
        echo "✓ All machine-readable indexes present"

    - name: Check for broken internal links
      run: |
        # Simple check: ensure referenced files exist
        cd docs
        grep -oE '\[[^\]]+\]\([^)]+\)' *.md 2>/dev/null | \
          grep -v 'http' | \
          sed 's/.*(\([^)]*\))/\1/' | \
          while read link; do
            if [ ! -f "$link" ] && [ ! -f "../$link" ]; then
              echo "Warning: Possible broken link: $link"
            fi
          done || true
        echo "✓ Link check complete"
